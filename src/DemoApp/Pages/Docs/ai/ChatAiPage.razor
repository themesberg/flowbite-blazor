@page "/docs/ai/chat"
@layout DocLayoutStackedDark
@using Flowbite.Components
@using Flowbite.Components.Chat
@using Flowbite.Icons
@using Flowbite.Icons.Extended

<PageTitle>AI Chat - Flowbite Blazor</PageTitle>

<main class="flex flex-col h-full min-x-0">


        <section class="flex-none flex flex-col max-w-4xl mx-auto space-y-1 py-2">
            <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">AI Chat Playground</h2>
            <p class=" text-gray-600 dark:text-gray-300">
                Connect to your preferred AI provider, supply a secure API key, and explore Flowbite chat primitives backed by 
                <a class="underline text-gray-900 dark:text-white font-medium" target="_blank" rel="noreferrer" href="https://llmtornado.ai/">LLM Tornado</a>.
            </p>
        </section>


        <Conversation>
            <ConversationContent AutoScrollBehavior="ConversationAutoScrollBehavior.StickToBottom" Class="px-0">
                @foreach (var message in Messages)
                {
                    <ChatMessage @key="message.Id"
                                From="message.Role"
                                AvatarInitials="@(message.Role == ChatMessageRole.Assistant ? "AI" : "You")"
                                Class="">
                        <ChatMessageContent Variant="@(message.Role == ChatMessageRole.User ? ChatMessageVariant.Contained : ChatMessageVariant.Flat)">
                            
                            @if (message.Reasoning is not null)
                            {
                                <Reasoning IsStreaming="message.IsStreaming"
                                        DurationSeconds="message.DurationSeconds">
                                    <ReasoningTrigger />
                                    <ReasoningContent Text="@message.Reasoning" />
                                </Reasoning>
                            }

                            <ChatResponse Text="@message.Text" Role="@message.Role">
                                @if (message.Attachments?.Count > 0)
                                {
                                    <ul class="mt-2 list-disc space-y-1 pl-5 text-xs text-gray-600 dark:text-gray-300">
                                        @foreach (var attachment in message.Attachments)
                                        {
                                            <li>@attachment</li>
                                        }
                                    </ul>
                                }
                            </ChatResponse>

                            @if (message.Sources?.Count > 0)
                            {
                                <Sources Count="message.Sources.Count">
                                    <SourcesTrigger />
                                    <SourcesContent>
                                        @foreach (var source in message.Sources)
                                        {
                                            <ChatSource Href="@source.Href">@source.Title</ChatSource>
                                        }
                                    </SourcesContent>
                                </Sources>
                            }
                        </ChatMessageContent>

                        <ChatActions Class="@(message.Role == ChatMessageRole.Assistant ? "justify-start -ml-3" : "justify-end ml-3")">
                            <ChatAction Tooltip="Copy" OnClick="@(() => CopyAsync(message.Text))">
                                <FileCopyIcon class="h-4 w-4" aria-hidden="true" />
                            </ChatAction>
                        </ChatActions>
                        
                    </ChatMessage>
                }

                @if (IsBusy)
                {
                    <div class="flex items-center gap-2 px-6 pb-6 text-sm text-gray-500 dark:text-gray-400">
                        <Loader />
                        <span>@BusyLabel</span>
                    </div>
                }
            </ConversationContent>

            <ConversationScrollButton />
        </Conversation>

        <PromptInput OnSubmit="HandleSubmitAsync" Text="@(InputText ?? string.Empty)" TextChanged="HandlePromptTextChanged" GlobalDrop="true" Multiple="true">
            <PromptInputHeader>
                <PromptInputAttachments>
                    <ChildContent Context="attachment">
                        <PromptInputAttachment Data="attachment" />
                    </ChildContent>
                </PromptInputAttachments>
            </PromptInputHeader>
            <PromptInputBody>
                <PromptInputTextarea Placeholder="Send a message..." />
            </PromptInputBody>
            <PromptInputFooter>
                <PromptInputTools>
                    <PromptInputActionMenu>
                        <PromptInputActionMenuTrigger>
                            <PlusIcon class="h-4 w-4" aria-hidden="true" />
                        </PromptInputActionMenuTrigger>
                        <PromptInputActionMenuContent>
                            <PromptInputActionAddAttachments />
                        </PromptInputActionMenuContent>
                    </PromptInputActionMenu>

                    <PromptInputButton Variant="PromptInputButtonVariant.Ghost"
                                    Active="@WebSearchEnabled"
                                    OnClick="ToggleWebSearchAsync">
                        <GlobeIcon class="h-4 w-4" aria-hidden="true" />
                        <span>@(WebSearchEnabled ? "Search on" : "Search")</span>
                    </PromptInputButton>

                    <PromptInputButton Variant="PromptInputButtonVariant.Ghost"
                                    Active="@MicrophoneEnabled"
                                    OnClick="ToggleMicrophoneAsync">
                        <MicrophoneIcon class="h-4 w-4" aria-hidden="true" />
                    </PromptInputButton>

                    <PromptInputModelSelect Value="@SelectedProviderKey"
                                            ValueChanged="HandleProviderChangedAsync">
                        <PromptInputModelSelectTrigger>
                            <PromptInputModelSelectValue Placeholder="Select provider" />
                            <ChevronDownIcon class="h-4 w-4 text-gray-400" aria-hidden="true" />
                        </PromptInputModelSelectTrigger>
                        <PromptInputModelSelectContent>
                            @foreach (var provider in Providers)
                            {
                                <PromptInputModelSelectItem Value="@provider.Key" Label="@provider.DisplayName" />
                            }
                        </PromptInputModelSelectContent>
                    </PromptInputModelSelect>

                    @if (!string.IsNullOrEmpty(SelectedProviderKey))
                    {
                        var selectedProvider = Providers.FirstOrDefault(p => p.Key == SelectedProviderKey);
                        if (selectedProvider != null)
                        {
                            <div class="flex items-center gap-1.5 px-2">
                                <span class="text-xs text-gray-500 dark:text-gray-400">@selectedProvider.DefaultModel</span>
                            </div>
                        }
                    }
                </PromptInputTools>

                <div class="flex flex-1 flex-col max-w-sm">
                    <div class="flex items-center ">
                        <input @bind="ApiKey"
                            @bind:event="oninput"
                            class="w-full bg-transparent rounded-lg text-sm text-gray-900 placeholder:text-gray-400 focus:outline-none border dark:border-gray-800 border-gray-200 dark:text-gray-100"
                            placeholder="Paste provider API key"
                            type="@ApiKeyInputType"
                            autocomplete="off"
                            spellcheck="false" />
                        <button type="button"
                                class="z-text-xs font-medium  text-primary-600 transition hover:text-primary-700 dark:text-primary-400 dark:hover:text-primary-300"
                                @onclick="ToggleApiKeyVisibility">
                            @if(ShowApiKey)
                            {
                                <EyeSlashIcon class="inline h-5 w-5 ml-2" aria-hidden="true" />
                            }
                            else
                            {
                                <EyeIcon class="inline h-5 w-5 ml-2" aria-hidden="true" />
                            }
                        </button>
                    </div>


                    @if (!string.IsNullOrEmpty(ApiKeyValidationMessage))
                    {
                        <span class="text-xs text-red-500 dark:text-red-400">@ApiKeyValidationMessage</span>
                    }
                </div>

                <PromptInputSubmit Status="@SubmissionStatus"
                                Disabled="IsSubmitDisabled"
                                Label=""
                                SubmittingLabel=""
                                StreamingLabel=""
                                ErrorLabel="">
                </PromptInputSubmit>
            </PromptInputFooter>
        </PromptInput>
        
    
</main>

@* sticky bottom-0 z-1 mx-auto flex w-full max-w-4xl gap-2 border-t-0 bg-background px-2 pb-3 md:px-4 md:pb-4 *@
